{{
extend 'layout.html'
}}

<meta name="description" content="Solver for the randomized Super Metroid roms"/>
<link rel="shortcut icon" href={{=URL('static','favicon.ico')}} type="image/ico"/>
<script src="{{=URL('static','js/FileSaver.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL('static','css/mystyle_20180928.css')}} media="screen"/>

<link rel="stylesheet" type="text/css" href={{=URL('static','dist/switchery.css')}} media="screen"/>
<script src="{{=URL('static','dist/switchery.js')}}"></script>

<link href={{=URL('static', 'css/bootstrap-tour.min.css')}} rel="stylesheet">
<script src="{{=URL('static','js/bootstrap-tour.min.js')}}"></script>

<script type="text/javascript" src="{{=URL('static', '/highslide/highslide.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "/highslide/highslide.css")}} />
<script type="text/javascript">
hs.graphicsDir = "/solver/static/highslide/graphics/";
hs.showCredits = 0;
hs.zIndexCounter = 1000000;
hs.dimmingOpacity = 0.75;

if (hs.registerOverlay) {
	// The simple semitransparent close button overlay
	hs.registerOverlay({
		thumbnailId: 'areathumb',
		html: '<div class="closebutton"	onclick="return hs.close(this)" title="Close"></div>',
		position: 'top right',
		fade: 2 // fading the semi-transparent overlay looks bad in IE
	});
}
</script>

<script type="text/javascript" src="{{=URL('static', 'js/chosen.jquery.min.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "css/chosen.css")}} />

<title>Super Metroid VARIA Randomizer</title>

<style>
.highslide-dimming {
    background: black;
}
#overlay {
    position: fixed; /* Sit on top of the page content */
    display: none; /* Hidden by default */
    width: 100%; /* Full width (cover the whole page) */
    height: 100%; /* Full height (cover the whole page) */
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.5); /* Black background with opacity */
    z-index: 2; /* Specify a stack order in case you're using a different order for other elements */
    cursor: pointer; /* Add a pointer on hover */
}
#loadingGIF {
    position: absolute;
    left: 5%;
    z-index: 3;
    display:none;
}
@media (max-height: 800px) {
    .loadingGIF {
         top: 20%;
    }
}
@media (min-height: 800px) {
    .loadingGIF {
         top: 40%;
    }
}
</style>

<script type="text/javascript">
function randomize(evt, elemId) {
  var e = document.getElementById(elemId);

  var isActive;
  if(evt.currentTarget.className.search("active") != -1) {
    evt.currentTarget.className = evt.currentTarget.className.replace(" active", "");
    isActive = false;

    defaultValues = {"missileQty": 3, "superQty": 2, "powerBombQty": 1, "minorQty": 100};

    if(e.value.length == 0 && elemId in defaultValues) {
      e.value = defaultValues[elemId];
    }

  } else {
    evt.currentTarget.className += " active";
    isActive = true;
  }

  e.disabled = isActive;
  // grey out the disabled text
  var text = document.getElementById(elemId+"Text");
  if(e.disabled) {
      text.className = "disabledText";
  } else {
      text.className = "";
  }
  // tell switchery
  if(elemId in globalSwitchs){
    var s = globalSwitchs[elemId];
    if(isActive){
      s.disable();
    } else {
      s.enable();
    }
  }
}

function getComplexity() {
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    if(tablinks[i].className.includes("active")) {
      return tablinks[i].id;
    }
  }
}

function setRandom() {
{{
  for id in ["missileQty", "superQty", "powerBombQty", "minorQty", "energyQty", "maxDifficulty", "progressionSpeed", "fullRandomization", "suitsRestriction", "morphPlacement", "funCombat", "funMovement", "funSuits", "progressionDifficulty", "hideItems", "strictMinors"]:
    if id in session.randomizer and session.randomizer[id] == "random":
      response.write('  document.getElementById("{}Random").click();'.format(id), escape=False)
      pass
    pass
}}
}

function setComplexity() {
{{
  if "complexity" in session.randomizer:
    response.write('  document.getElementById("{}").click();'.format(session.randomizer["complexity"]), escape=False)
  else:
    response.write('  document.getElementById("simple").click();', escape=False)
    pass
}}
}

function changeComplexity(evt, name) {
  if(name == "simple") {
    var show = [];
    var hide = ["seedVisibility", "ammoVisibility", "maxDiffVisibility", "progDiffVisibility", "suitsRestrictionVisibility", "morphPlacementVisibility", "superFunVisibility", "patchesVisibility", "areaPatchVisibility", "hideItemsVisibility", "raceModeVisibility"];
    showHide(show, hide);
  }

  else if(name == "medium") {
    var show = ["maxDiffVisibility", "patchesVisibility", "morphPlacementVisibility", "ammoVisibility"
{{
for patch in patches:
  if patch[3] == True:
    response.write(", \"{}Visibitily\"".format(patch[0]), escape=False)
    pass
  pass
}}];
    var hide = ["seedVisibility", "progDiffVisibility", "suitsRestrictionVisibility", "strictMinorsVisibility", "missileQtyVisibility", "superQtyVisibility", "powerBombQtyVisibility", "superFunVisibility", "areaPatchVisibility", "mainPatchesVisibitily", "mainPatchesTextVisibitily", "hideItemsVisibility", "raceModeVisibility"
{{
for patch in patches:
  if patch[3] == False:
    response.write(", \"{}Visibitily\"".format(patch[0]), escape=False)
    pass
  pass
}}];
    showHide(show, hide);
  }

  else {
    var show = ["seedVisibility", "ammoVisibility", "maxDiffVisibility", "progDiffVisibility", "suitsRestrictionVisibility", "morphPlacementVisibility", "strictMinorsVisibility", "missileQtyVisibility", "superQtyVisibility", "powerBombQtyVisibility", "superFunVisibility", "patchesVisibility", "areaPatchVisibility", "mainPatchesVisibitily", "mainPatchesTextVisibitily", "hideItemsVisibility", "raceModeVisibility"
{{
for patch in patches:
  response.write(", \"{}Visibitily\"".format(patch[0]), escape=False)
  pass
}}];
    var hide = [];
    showHide(show, hide);
  }

  // set current button to active
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  evt.currentTarget.className += " active";
}

function showHide(show, hide) {
  for(var i=0; i<show.length; i++) {
    var showId = show[i];
    var elem = document.getElementById(showId);
    elem.classList.remove("hidden");
  }
  for(var i=0; i<hide.length; i++) {
    var hideId = hide[i];
    var elem = document.getElementById(hideId);
    elem.classList.add("hidden");
  }
}

var globalSwitchs = {};

function AjaxPresetCallCompleted(data) {
    console.log("AjaxPresetCallCompleted");

    var dataDict = {paramsFileTarget : data, "complexity": getComplexity()};
    var elems = ["seed", "itemsounds", "spinjumprestart", "elevators_doors_speed", "skip_ceres", "skip_intro", "animals", "layoutPatches", "noGravHeat", "areaLayout", "variaTweaks", "areaRandomization", "No_Music", "preset"];
    var randomElems = ["missileQty", "superQty", "powerBombQty", "minorQty", "energyQty", "maxDifficulty", "progressionSpeed", "fullRandomization", "suitsRestriction", "morphPlacement", "funCombat", "funMovement", "funSuits", "progressionDifficulty", "hideItems", "strictMinors"];

    for(var i=0; i<elems.length; i++) {
       dataDict[elems[i]] = document.getElementById(elems[i]).value;
    }
    for(var i=0; i<randomElems.length; i++) {
       // check if random dice is checked
       if(document.getElementById(randomElems[i]+"Random").className.search("active") != -1) {
         dataDict[randomElems[i]] = "random";
       } else {
         dataDict[randomElems[i]] = document.getElementById(randomElems[i]).value;
       }
    }

    // add race mode
    var raceMode = document.getElementById("raceMode");
    if(raceMode.checked) {
      var maxHourRace = document.getElementById("maxHourRace");
      dataDict["raceMode"] = maxHourRace.value;
    }

    // call web service with parameters
    var request = $.ajax({
      url: "{{=URL(f='randomizerWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "json",
      crossDomain: true
    });

    request.done(AjaxRandomizerCallCompleted);
    request.fail(ajaxFailJSON);
}

function ajaxFail(jqXHR, textStatus) {
  document.getElementById("flash").innerHTML = jqXHR.responseText;
  $('#flash').show();
  $('#overlay').hide();
  $('#loadingGIF').hide();
}

function ajaxFailJSON(jqXHR, textStatus) {
  // cross domain calls currently return 'undefined' information... (cf. https://www.html5rocks.com/en/tutorials/cors/)
  if(jqXHR.responseJSON == null) {
    document.getElementById("flash").innerHTML = "Something wrong happened or the VARIA randomizer aborted: please try again. If this happens again after retrying, raise or disable max difficulty setting, and/or disable Super Fun Times (TM) setting. If Area Randomization was selected, try to enable Full Randomization as well.";
  } else {
    document.getElementById("flash").innerHTML = jqXHR.responseJSON;
  }
  $('#flash').show();
  $('#overlay').hide();
  $('#loadingGIF').hide();
}

function AjaxRandomizerCallCompleted(data) {
    console.log("AjaxRandomizerCallCompleted");

    // with items/Locations patch the local rom in memory
    var filesInput = document.getElementById("uploadFile");
    var file = filesInput.files[0]

    var reader = new FileReader();
    reader.readAsArrayBuffer(file)

    reader.onload = function(e) {
        var bytes = new Uint8Array(e.target.result);

        for(var key in data) {
            if(key === "fileName" || key === "errorMsg") { continue; }
            bytes[key] = data[key];
        }

        var blob = new Blob([bytes], {type: "octet/stream"})

        var outFileName = data['fileName']
        saveAs(blob, outFileName)
    }

    // info message to display ?
    if("errorMsg" in data && data["errorMsg"].length > 0) {
        document.getElementById("flash").innerHTML = data["errorMsg"];
        $('#flash').show();
        displayFlash = true;
    } else {
        displayFlash = false;
    }

    // set backup button text to Randomize
    document.getElementById("submitBtn").data = "Randomize";
    console.log("button text set back to randomize");

    var dataDict = {"complexity": getComplexity()};
    var elems = ["itemsounds", "spinjumprestart", "elevators_doors_speed", "skip_ceres", "skip_intro", "animals", "layoutPatches", "noGravHeat", "areaLayout", "variaTweaks", "areaRandomization", "No_Music", "preset", "randoPreset"];
    var randomElems = ["missileQty", "superQty", "powerBombQty", "minorQty", "energyQty", "maxDifficulty", "progressionSpeed", "fullRandomization", "suitsRestriction", "morphPlacement", "funCombat", "funMovement", "funSuits", "progressionDifficulty", "hideItems", "strictMinors"];

    for(var i=0; i<elems.length; i++) {
       dataDict[elems[i]] = document.getElementById(elems[i]).value;
    }
    for(var i=0; i<randomElems.length; i++) {
       // check if random dice is checked
       if(document.getElementById(randomElems[i]+"Random").className.search("active") != -1) {
         dataDict[randomElems[i]] = "random";
       } else {
         dataDict[randomElems[i]] = document.getElementById(randomElems[i]).value;
       }
    }

    // call webservice to update the session
    var request = $.ajax({
      url: "{{=URL(f='sessionWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "html"
    });

    request.fail(ajaxFail);

    // remove "working" message
    if(displayFlash == false){
        $('#flash').hide();
    }
    $('#overlay').hide();
    $('#loadingGIF').hide();
}

function doSubmit() {
  if(window.File && window.FileList && window.FileReader) {

    var filesInput = document.getElementById("uploadFile");
    var file = filesInput.files[0]
    if (file === undefined) {
      alert("Please select a Super Metroid Vanilla ROM first")
      btn = document.getElementById("submitBtn");
      btn.data = "Randomize";
      btn.disabled = false;

      setTimeout(function(){ 
          btn = document.getElementById("submitBtn");
          btn.data = "Randomize";
          btn.disabled = false;
      }, 20000);

      return false;
    }

    var dataDict = {"preset": document.getElementById("preset").value};

    console.log("before preset web service call"+dataDict["preset"]);

    // call preset web service with parameters
    var request = $.ajax({
      url: "{{=URL(f='presetWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "html"
    });

    request.done(AjaxPresetCallCompleted);
    request.fail(ajaxFail);

    // while WS is working, display "working" message
    $('#overlay').show();
    $('#loadingGIF').show();
  }

  return false;
}

window.onload = function(){
    //Check File API support
    if(window.File && window.FileList && window.FileReader) {
        var filesInput = document.getElementById("uploadFile");
        filesInput.addEventListener("change", function(event){
            var files = event.target.files; //It returns a FileList object
            var file = files[0];

            var reader = new FileReader();
            reader.onload = function(e) {
		// check sfc or smc extention
                var re = /(?:\.([^.]+))?$/;
		var ext = re.exec(file.name)[1];
                console.log("ext: "+ext)
                if( ! (ext === "sfc" || ext === "smc") ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong extension: "+ext);
                    return false;
                }

                var fileSize = file.size;
		if( fileSize > 4*1024*1024 ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong rom file size: "+fileSize.toString());
                    return false;
                }
            }

            reader.readAsArrayBuffer(file)

        }, false);
    } else {
        alert("This website requires the HTML5 File API, please upgrade your browser to a newer version.");
    }

    var skipCeres = document.getElementById("skip_ceres");
    skipCeres.onchange = function(){
        var skipCeres = document.getElementById("skip_ceres");
        var skipIntro = document.getElementById("skip_intro");

        // if both are set, unselect the other one
        if(skipCeres.checked && skipIntro.checked){
            skipIntro.click();
        }
        // if none are set, select the other one
        if(! skipCeres.checked && ! skipIntro.checked){
            skipIntro.click();
        }

        switchCheckbox("skip_ceres");
    };

    var skipIntro = document.getElementById("skip_intro");
    skipIntro.onchange = function(){
        var skipCeres = document.getElementById("skip_ceres");
        var skipIntro = document.getElementById("skip_intro");

        if(skipIntro.checked && skipCeres.checked){
            skipCeres.click();
        }
        if(! skipCeres.checked && ! skipIntro.checked){
            skipCeres.click();
        }
        switchCheckbox("skip_intro");
    };

    // if none are set, activate skip ceres
    if(! skipCeres.checked && ! skipIntro.checked){
        skipCeres.click();
    }

    var area = document.getElementById("areaRandomization");
    area.onchange = function(){
        var area = document.getElementById("areaRandomization");
        var maxDiff = document.getElementById("maxDifficulty");
        var full = document.getElementById("fullRandomization");
        var patches = document.getElementById("areaLayout");
        var lateMorph = document.getElementById("morphPlacement");
        var suits = document.getElementById("suitsRestriction");

        if(area.checked){
            if(! full.checked) {
                full.click();
            }
            if(maxDiff.value == "no difficulty cap"){
                maxDiff.value = "hardcore";
            }
            if(! patches.checked){
                patches.click();
            }
            // uncheck suits restrictions when late morph + area
            if(lateMorph.options[lateMorph.selectedIndex].text == "late"){
                if(suits.checked){
                    suits.click();
                }
            }
        } else {
            if(patches.checked){
                patches.click();
            }
        }
        switchCheckbox("areaRandomization");
    };

    // uncheck suits restrictions when late morph + area
    var lateMorph = document.getElementById("morphPlacement");
    lateMorph.onchange = function(){
        var lateMorph = document.getElementById("morphPlacement");
        var area = document.getElementById("areaRandomization");
        var suits = document.getElementById("suitsRestriction");

        if(lateMorph.options[lateMorph.selectedIndex].text == "late"){
            if(area.checked){
                if(suits.checked){
                    suits.click();
                }
            }
        }
    }

    var progSpeed = document.getElementById("progressionSpeed");
    progSpeed.onchange = function(){
        var progSpeed = document.getElementById("progressionSpeed");
        if(progSpeed.value == 'slow' || progSpeed.value == 'slowest'){
            // set suits restriction only if not area + late morph
            var suitsRestriction = document.getElementById("suitsRestriction");
            var lateMorph = document.getElementById("morphPlacement");
            var area = document.getElementById("areaRandomization");
            if(! suitsRestriction.checked && ! (area.checked && lateMorph.options[lateMorph.selectedIndex].text == "late")){
                suitsRestriction.click();
            }
        }
        if(progSpeed.value == 'fast' || progSpeed.value == 'fastest'){
            var suitsRestriction = document.getElementById("suitsRestriction");

            if(suitsRestriction.checked){
                suitsRestriction.click();
            }
        }
    }

    // race mode is disabled by default
    var text = document.getElementById("raceModeText");
    var maxHourRace = document.getElementById("maxHourRace");
    text.className = "disabledText";
    maxHourRace.disabled = true;

    var raceMode = document.getElementById("raceMode");
    raceMode.onchange = function() {
      var raceMode = document.getElementById("raceMode");
      var text = document.getElementById("raceModeText");
      var maxHourRace = document.getElementById("maxHourRace");
      if(raceMode.checked){
        text.className = "";
        maxHourRace.disabled = false;
      } else {
        text.className = "disabledText";
        maxHourRace.disabled = true;
      }
    }

    var inputs = document.getElementsByTagName("input");
    for(var i = 0; i < inputs.length; i++) {
        if(inputs[i].type == "checkbox") {
            var s = new Switchery(document.getElementById(inputs[i].name), { size: 'small', color: '#ddd' });
            globalSwitchs[inputs[i].name] = s;
        }
    }

    setComplexity();

    setRandom();

    $(".chzn-select").chosen();
}

function switchCheckbox(id, elems=[]) {
  var check = document.getElementById(id);
  if(check.checked){
    check.value = "on";
  } else {
    check.value = "off";
  }

  for(var i=0; i<elems.length; i++){
    elemId = elems[i];
    var e = document.getElementById(elemId);
    e.disabled = check.checked;
    // grey out the disabled text
    var text = document.getElementById(elems[i]+"Text");
    if(e.disabled) {
        text.className = "disabledText";
    } else {
        text.className = "";
    }
    // tell switchery
    if(elemId in globalSwitchs){
      var s = globalSwitchs[elemId];
      if(check.checked){
        s.disable();
      } else {
        s.enable();
      }
    }
  }
}

function loadRandoPreset() {
  console.log("loadRandoPreset: "+document.getElementById("randoPreset").value);

  var dataDict = {"randoPreset": document.getElementById("randoPreset").value, "complexity": getComplexity()};

  // call web service to update the session with the params from the rando preset and reload the page
  var request = $.ajax({
      url: "{{=URL(f='randoPresetWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "html"
  });

  request.done(loadRandoPresetOK);
  request.fail(ajaxFail);
}

function loadRandoPresetOK() {
  location.reload();
}

function startTheTour(step=-1) {
  // the tour tutorial
  var tour = new Tour({
    storage: false,
    steps: [
    {
      element: "#uploadFile",
      title: "Vanilla Super Metroid ROM",
      content: "Use an American/Japan unheadered ROM of Super Metroid.<br/>The randomized ROM is generated locally."
    },
    {
      element: "#seed",
      title: "Randomizer seed",
      content: "Choose a seed number between 1 and 9999999, choose 0 to generate a random one."
    },
    {
      element: "#presetStep",
      title: "Standard Preset",
      content: "The preset is used by the Randomizer to know which techniques are available to reach the items locations.</br>You can create and manage your preset on the <a href=\"/solver/solver_web/presets\">Presets part of the website</a>.<br/>Load one of the standard presets (sorted in increased difficulty), or your own from the community presets.<br/>Creating your own preset will lead to a better experience overall, as the generated ROMs will be tailored for you."
    },
    {
      element: "#randoPresetStep",
      title: "Randomizer Preset",
      content: "Choose from a list of typical Randomizer usages. They're independent from skills preset, and settings can still be changed after loading the preset:<ul><li>all_random: all the parameters are set to random</li><li>default: VARIA randomizer default settings</li><li>free: easiest possible settings</li><li>Season_Races: settings used for rando league races</li><li>stupid_hard: hardest possible settings</li><li>vanilla: closest possible to vanilla Super Metroid</li><li>where_is_morph: Area mode with late Morph</li></ul>"
    },
    {
      element: "#raceStep",
      title: "Race",
      content: "When enabled, makes it difficult to cheat by using a Super Metroid editor like SMILE.<br/>You can choose how many hours must pass before a Race Mode seed can be solved on the VARIA website (default is 24)."
    },
    {
      element: "#fullRandomizationStep",
      title: "Full randomization",
      content: "Activate this option to have all items fully randomized.<br/>If disabled, the randomizer will behave like Total randomizer, with major and minor item pools.<br/>Minor items are Missile, Super Missile and Power Bomb packs. Major items are all the rest, including energy.<br/><b>Note:</b> High-Jump boots energy tank location is considered minor, and right Super Missile in Wrecked ship is considered major for balancing purposes.<br/>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#maxDifficulty",
      title: "Maximum difficulty for picking up an item",
      content: "Depending on the perceived difficulties of the techniques, bosses, hell runs etc. from the preset, it will prevent the Randomizer from placing an item in a location too difficult to reach with the current items.<br/><b>Warning:</b> if too low may cause the randomizer to abort.<br/>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#progressionSpeed",
      title: "Progression speed",
      content: "A progression item is an item opening new locations once picked up : suit, movement item, or any item that opens up locations when placed by the Randomizer.<br/>This parameter influences how fast progression items are likely to be found. From <b>slowest</b>, stuffing your way with as many non-progression items as possible, to <b>fastest</b>, where you will be able to visit Zebes pretty shortly.<br/>You can also pick <b>basic</b>, in which case VARIA will place the items exactly like Dessyreqt Randomizer, or Total Randomizer in its Normal/Casual setting.<br/><b>Note:</b> usually, slower settings will result in more difficult seeds, and faster settings in easier seeds. Basic progression speed usually result in easy/fast seeds, but not always.<br/>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#progressionDifficulty",
      title: "Progression difficulty",
      content: "This parameter influences the choice of the next location. It uses the perceived difficulties from the preset to compute the difficulty to reach the locations. Then if <b>easier</b> or <b>harder</b> is selected, the easiest or hardest location will have a higher chance of being chosen.<br/>Set it to <b>normal</b> for the Randomizer to randomly choose the next location.<br/><b>Note:</b> this setting has less of an influence on actual seed difficulty than Progression Speed.<br/>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#morphPlacementStep",
      title: "Morph Placement",
      content: "Influences where VARIA will place Morphing Ball :<ul><li><b>early</b> (default): Morph will be either at its vanilla spot, or in the ceiling at the Blue Brinstar Energy Tank spot (like Total Randomizer)</li><li><b>normal</b>: Morph will be placed randomly (like Dessy Randomizer)</li><li><b>late</b>: Prevents Morph to be placed in the first area of the game (Crateria/Blue Brinstar). Best suited when used along area randomization, to find Morph in peculiar places.</li></ul>"
    },
    {
      element: "#suitsRestrictionStep",
      title: "Suits restriction",
      content: "Prevent Gravity or Varia suits to be placed early in the game.<br/>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#hideItemsStep",
      title: "Hide Items",
      content: "Like in Dessy's randomizer, hides half of the visible items.<br/>Items always visible:<ul><li>Energy Tank, Gauntlet</li><li>Energy Tank, Terminator</li><li>Morphing Ball</li><li>Missile (Crateria moat)</li><li>Missile (green Brinstar below super missile)</li><li>Missile (above Crocomire)</li><li>Power Bomb (lower Norfair above fire flea room)</li><li>Missile (Gravity Suit)</li><li>Missile (green Maridia shinespark)</li></ul>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#strictMinorsStep",
      title: "Strict ammo distribution",
      content: "Instead of using the Minors proportions as probabilities, enforce a strict distribution to match the proportions as exactly as possible.<br/>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#missileQty",
      title: "Proportion of Missiles/Super Missiles/Power Bombs",
      content: "For each minor types, the higher the number the higher the probability of choosing it when placing a minor.<br/>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#minorQty",
      title: "Percentage of minors available",
      content: "From 1%: minimum number of minors required to finish the game to 100%: all minors locations contain a minor (vanilla like).<br/>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#energyQty",
      title: "Quantity of Energy/Reserve Tanks available",
      content: "Choose how many Energy/Reserve Tanks will be available, from 4-6 in sparse, 8-12 in medium and 18 in vanilla.<br/>Click on the dice button to randomly set this parameter."
    },
    {
      element: "#areaRandomizationStep",
      title: "Area randomization",
      content: "Randomize areas together using bidirectional access portals: <a href=\"/solver/static/images/area_map.png\" class=\"highslide\" onclick=\"return hs.expand(this, {wrapperClassName: 'borderless', dimmingOpacity: 0.75, align: 'center'})\"><img id=\"areathumb\" src=\"/solver/static/images/area_map_thumbnail.png\" alt=\"Area Map\" title=\"Click to enlarge\"/></a><br/>All portals can be linked to one another, even if it means following an incompatible transition (Left-Left, Up-Right, ...).<br/>You can go through all portals and back, even those where you can't do that in vanilla, so:<ul><li>Some doors have been turned to blue</li><li>Both Maridia exit green gates have been removed</li><li>Crumble blocks preventing access to Lower Nofair through its exit have been removed</li></ul>Use the <a href=\"/solver/solver_web/tracker\">area tracker</a> to find your way more easily.<br/><b>Note:</b> enabling it also auto-enables Full Randomization and set difficulty cap to hardcore (if it wasn't already easier) to avoid generating too hard seeds, but it can still be changed afterwards.",
      placement: "auto left"
    },
    {
      element: "#areaLayoutStep",
      title: "Area randomization additional layout modifications",
      content: "Some layout tweaks to make your life easier in area randomizer :<br/><ul>\
<li>Remove Crab green gate in Marida</li>\
<li>Remove blue gate in Green Hill Zone</li>\
<li>New platform in Green Hill Zone to access transition door</li>\
<li>Made access paths to the three most 'hidden' portals more obvious so you don't forget to check them</li></ul>",
      placement: "auto left"
    },
    {
      element: "#funCombatStep",
      title: "Super Fun Combat",
      content: "Forces removal of Plasma Beam, and Screw Attack if the preset and settings allow it.<br/>In addition, can randomly remove some items from the Combat set:<br/><ul><li>Spazer</li><li>Wave Beam</li></ul>Click on the dice button to randomly set this parameter.",
      placement: "auto left"
    },
    {
      element: "#funMovementStep",
      title: "Super Fun Movement",
      content: "Forces removal of Space Jump if the preset allows it.<br/>In addition, can randomly remove some items from the Movement set:<br/><ul><li>Hi Jump</li><li>Grappling Beam</li><li>Spring Ball</li><li>Speed Booster</li><li>Bombs</li></ul>Click on the dice button to randomly set this parameter.",
      placement: "auto left"
    },
    {
      element: "#funSuitsStep",
      title: "Suitless",
      content: "If the preset and seed layout allow it, will force removal of at least one suit.<br/>Click on the dice button to randomly set this parameter.",
      placement: "auto left"
    },
    {
      element: "#patchesStep",
      title: "Default Patches",
      content: "Patches also included by default:<ul><li>Allows the aim buttons to be assigned to any button (by Kejardon)</li><li>Max Ammo Display (by Personitis)</li><li>Play music with MSU1 chip on SD2SNES (by DarkShock)</li></ul>",
      placement: "auto left"
    },
    {
      element: "#layoutPatchesStep",
      title: "Layout patches",
      content: "Include the anti-softlock layout patches from Total Item Randomizer. Disable at your own softlocking risk!\
<ul><li>Disable respawning blocks at Dachora Pit</li>\
<li>Make it possible to escape from below early Super bridge without Bombs</li>\
<li>Replace bomb blocks with shot blocks before Hi-Jump</li>\
<li>Replace bomb blocks with shot blocks at Moat</li>\
<li>Raise platform in first heated Norfair room to not require Hi-Jump</li>\
<li>Raise platforms in Red Tower bottom to always be able to get back up</li>\
<li>Replace bomb blocks with shot blocks before Spazer</li></ul>",
      placement: "auto left"
    },
    {
      element: "#noGravHeatStep",
      title: "Optional patches",
      content: "Patch from Total Item Randomizer to remove the Gravity Suit environmental protection (heat, spikes, electricity...), it balances more the two suits abilities. Disable it to have a more vanilla feeling.",
      placement: "auto left"
    },
    {
      element: "#variaTweaksStep",
      title: "Optional patches",
      content: "Include minor tweaks for the game to behave 'as it should' in a randomizer context :\
<ul><li>Bomb Torizo fight is triggered when picking up the item he's holding, not by having Bomb</li>\
<li>Access item at Wrecked Ship Etank location without killing Phantoon (via Forgotten Highway)</li>\
<li>Activate Lower Norfair Chozo (left of entrance) without Space Jump</li></ul>",
      placement: "auto left"
    } ]});

  // Initialize the tour
  tour.init();

  // Start the tour
  if(step != -1) {
    tour.goTo(step);
  }
  tour.start();
}
</script>
{{
def displayCheckbox(id, defaultTrue=False):
  if (id in session.randomizer and session.randomizer[id] == 'on') or (id not in session.randomizer and defaultTrue == True):
}}
    {{=INPUT(_id=id, _name=id, _type="checkbox", _checked="checked", _value="on", _class="js-switch", _onchange="switchCheckbox('{}')".format(id))}}
{{
  else:
}}
    {{=INPUT(_id=id, _name=id, _type="checkbox", _value="off", _class="js-switch", _onchange="switchCheckbox('{}')".format(id))}}
    {{pass}}
  {{pass}}

{{
def displaySelect(id, values, default):
  if id in session.randomizer:
    value = session.randomizer[id]
  else:
    value = default
    pass
}}
  {{
   =SELECT(*values,
           **dict(_id=id, _name=id, value=value, _class="full"))
  }}
{{pass}}
{{
def displayNumber(id, min, max, default, step="1"):
  if id in session.randomizer:
    value = session.randomizer[id]
  else:
    value = default
    pass

  response.write("<input name=\"{}\" id=\"{}\" type=\"number\" value=\"{}\" min=\"{}\" max=\"{}\" step=\"{}\" class=\"full\" required>".format(id, id, value, min, max, step), escape=False)
  pass
}}
<body>
  <div id="overlay"></div>
  <div id="loadingGIF"><img src={{=URL('static/images','ajax-loader.gif')}}/></div>

  <div class="fixed">
    <div class="menu">
    <table class="full menuTable">
      <tr>
	<td>{{=A("Home", _href=URL(f="home"), _class="menu")}}</td>
	<td>{{=A("Presets", _href=URL(f="presets"), _class="menu")}}</td>
	<td class="menu_selected">{{=A("Randomizer", _href=URL(f="randomizer"), _class="menu")}}</td>
	<td>{{=A("Solver", _href=URL(f="solver"), _class="menu")}}</td>
	<td>{{=A("Trackers", _href=URL(f="tracker"), _class="menu")}}</td>
	<td>{{=A("Information & Contact", _href=URL(f="infos"), _class="menu")}}</td>
      </tr>
    </table>
    </div>
  </div>

  <div class="main">
    <div id="complexityTabs" class="center">
      <div class="tab">
        <button class="tablinks" id="simple" onclick="changeComplexity(event, 'simple');">Simple</button>
        <button class="tablinks" id="medium" onclick="changeComplexity(event, 'medium');">Medium</button>
        <button class="tablinks" id="advanced" onclick="changeComplexity(event, 'advanced');">Advanced</button>
      </div>
    </div>
    <form id="mainform" name="mainform" onsubmit="doSubmit(); return false;">
      <div id="tabRando" class="tabcontent">
        <div class="row">
	  <div class="column">
	    <p>The Very Adaptive Randomizer of Items and Area (VARIA) randomizer will generate a Super Metroid ROM finishable using the known techniques of the chosen preset.</p>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr>
                <td>Vanilla Super Metroid ROM:</td>
                <td>{{=INPUT(_type="file", _name="uploadFile", _id="uploadFile", _class="full")}}</td>
                <td><button type="button" onclick="startTheTour(0)">?</button></td>
              </tr>
              <tr id="seedVisibility">
	        <td>Randomizer seed:</td>
	        <td>{{displayNumber("seed", "0", "9999999", "0")}}</td>
	        <td><button type="button" onclick="startTheTour(1)">?</button></td>
              </tr>
              <tr>
		<td>Skills Preset:</td>
		<td>{{=SELECT(OPTGROUP(*stdPresets, **dict(_label="Standard presets")), OPTGROUP(*comPresets, **dict(_label="Community presets")), **dict(_name="preset", _id="preset", value=session.randomizer["preset"], _class="filldropdown chzn-select"))}}</td>
		<td id="presetStep"><button type="button" onclick="startTheTour(2)">?</button></td>
              </tr>
		<td>Settings Preset:</td>
		<td>{{=SELECT(*randoPresets, **dict(_name="randoPreset", _id="randoPreset", value=session.randomizer["randoPreset"] if "randoPreset" in session.randomizer else "default", _class="filldropdown chzn-select", _onchange="loadRandoPreset()"))}}</td>
		<td id="randoPresetStep"><button type="button" onclick="startTheTour(3)">?</button></td>
              </tr>
	      <tr id="raceModeVisibility">
		<td>{{displayCheckbox("raceMode")}}<span id="raceModeText">Race Mode</span></td>
		<td>{{displaySelect("maxHourRace", [2,4,8,12,24,48,72], 24)}}</td>
		<td id="raceStep"><button type="button" onclick="startTheTour(4)">?</button></td>
	      </tr>
            </table>
	    <br/>
	    <h4>Randomizer parameters</h4>
	    <table class="full">
	      <tr>
		<td class="small"><div class="random"><button id="fullRandomizationRandom" type="button" onclick="randomize(event, 'fullRandomization')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
	        <td colspan="2" id="fullRandomizationStep">{{displayCheckbox("fullRandomization")}}<span id="fullRandomizationText">Full randomization</span></td>
                <td><button type="button" onclick="startTheTour(5)">?</button></td>
	      </tr>
              <tr id="maxDiffVisibility">
		<td class="small"><div class="random"><button id="maxDifficultyRandom" type="button" onclick="randomize(event, 'maxDifficulty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td><span id="maxDifficultyText">Maximum difficulty for picking up an item:</span></td>
                <td>{{displaySelect("maxDifficulty", ["no difficulty cap", "easy", "medium", "hard", "harder", "hardcore", "mania"], "no difficulty cap")}}</td>
                <td><button type="button" onclick="startTheTour(6)">?</button></td>
              </tr>
	      <tr>
		<td class="small"><div class="random"><button id="progressionSpeedRandom" type="button" onclick="randomize(event, 'progressionSpeed')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
	        <td class="half"><span id="progressionSpeedText">Progression speed:</span></td>
                <td class="half">{{displaySelect("progressionSpeed", ["slowest", "slow", "medium", "fast", "fastest", "basic"], "medium")}}</td>
                <td><button type="button" onclick="startTheTour(7)">?</button></td>
	      </tr>
	      <tr id="progDiffVisibility">
		<td class="small"><div class="random"><button id="progressionDifficultyRandom" type="button" onclick="randomize(event, 'progressionDifficulty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
	        <td class="half"><span id="progressionDifficultyText">Progression difficulty:</span></td>
                <td class="half">{{displaySelect("progressionDifficulty", ["easier", "normal", "harder"], "normal")}}</td>
                <td><button type="button" onclick="startTheTour(8)">?</button></td>
	      </tr>
	      <tr id="morphPlacementVisibility">
		<td class="small"><div class="random"><button id="morphPlacementRandom" type="button" onclick="randomize(event, 'morphPlacement')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
	        <td class="half"><span id="morphPlacementText">Morph Placement:</span></td>
	        <td class="half" id="morphPlacementStep">{{displaySelect("morphPlacement", ["early", "normal", "late"], "normal")}}</td>
                <td><button type="button" onclick="startTheTour(9)">?</button></td>
	      </tr>
	      <tr id="suitsRestrictionVisibility">
		<td class="small"><div class="random"><button id="suitsRestrictionRandom" type="button" onclick="randomize(event, 'suitsRestriction')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
	        <td colspan="2" id="suitsRestrictionStep">{{displayCheckbox("suitsRestriction")}}<span id="suitsRestrictionText">Suits restriction</span></td>
                <td><button type="button" onclick="startTheTour(10)">?</button></td>
	      </tr>
	      <tr id="hideItemsVisibility">
		<td class="small"><div class="random"><button id="hideItemsRandom" type="button" onclick="randomize(event, 'hideItems')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		<td colspan="2" id="hideItemsStep">{{displayCheckbox("hideItems")}}<span id="hideItemsText">Hide some items</span></td>
		<td><button type="button" onclick="startTheTour(11)">?</button></td>
	      </tr>
	    </table>
	    <div id="ammoVisibility">
	      <h4>Ammo and Energy</h4>
	      <table class="full">
                <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
                <tr id="strictMinorsVisibility">
		  <td class="small"><div class="random"><button id="strictMinorsRandom" type="button" onclick="randomize(event, 'strictMinors')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td colspan="2" id="strictMinorsStep">{{displayCheckbox("strictMinors")}}<span id="strictMinorsText">Strict Minors distribution</span></td>
		  <td><button type="button" onclick="startTheTour(12)">?</button></td>
                </tr>
                <tr id="missileQtyVisibility">
		  <td class="small"><div class="random"><button id="missileQtyRandom" type="button" onclick="randomize(event, 'missileQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="missileQtyText">Proportion of Missiles:</span></td>
		  <td>{{displayNumber("missileQty", "1", "9", "3", "0.1")}}</td>
		  <td><button type="button" onclick="startTheTour(13)">?</button></td>
                </tr>
                <tr id="superQtyVisibility">
		  <td class="small"><div class="random"><button id="superQtyRandom" type="button" onclick="randomize(event, 'superQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="superQtyText">Proportion of Super Missiles:</span></td>
		  <td>{{displayNumber("superQty", "1", "9", "3", "0.1")}}</td>
                </tr>
                <tr id="powerBombQtyVisibility">
		  <td class="small"><div class="random"><button id="powerBombQtyRandom" type="button" onclick="randomize(event, 'powerBombQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="powerBombQtyText">Proportion of Power Bombs:</span></td>
		  <td>{{displayNumber("powerBombQty", "1", "9", "1", "0.1")}}</td>
                </tr>
                <tr>
		  <td class="small"><div class="random"><button id="minorQtyRandom" type="button" onclick="randomize(event, 'minorQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="minorQtyText">Percentage of minors available:</span></td>
		  <td>{{displayNumber("minorQty", "1", "100", "100")}}</td>
		  <td><button type="button" onclick="startTheTour(14)">?</button></td>
                </tr>
                <tr>
		  <td class="small"><div class="random"><button id="energyQtyRandom" type="button" onclick="randomize(event, 'energyQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="energyQtyText">Quantity of Energy/Reserve Tanks available:</span></td>
		  <td>{{displaySelect("energyQty", ["sparse", "medium", "vanilla"], "vanilla")}}</td>
		  <td><button type="button" onclick="startTheTour(15)">?</button></td>
                </tr>
	      </table>
	    </div>
	  </div>
	  <div class="column">
            <h4>Area Randomization</h4>
            <p>
	      Add more randomness to your seed by randomizing the access between the areas.<br/>
	      Check the help button for the map of the areas and the access points between them.
            </p>
	    <table class="full">
	      <tr>
	        <td colspan="2" class="full" id="areaRandomizationStep">{{displayCheckbox("areaRandomization")}}Area randomization</td>
                <td><button type="button" onclick="startTheTour(16)">?</button></td>
	      </tr>
	      <tr id="areaPatchVisibility">
		<td colspan="2" class="full" id="areaLayoutStep">{{displayCheckbox("areaLayout", False)}} Additional layout patches for easier navigation</td><td><button type="button" onclick="startTheTour(17)">?</button></td>
	      </tr>
            </table>
	    <div id="superFunVisibility">
              <h4>Super Fun Times (TM)</h4>
              <p>
                Have fun randomly removing major items!<br/>
                <b>Warning:</b> For experienced players only.
              </p>
	      <table class="full">
                <tr>
		  <td class="small"><div class="random"><button id="funCombatRandom" type="button" onclick="randomize(event, 'funCombat')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td colspan="2" class="full" id="funCombatStep">{{displayCheckbox("funCombat")}}<span id="funCombatText">Super Fun Combat</span></td>
		  <td><button type="button" onclick="startTheTour(18)">?</button></td>
                </tr>
                <tr>
		  <td class="small"><div class="random"><button id="funMovementRandom" type="button" onclick="randomize(event, 'funMovement')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td colspan="2" class="full" id="funMovementStep">{{displayCheckbox("funMovement")}}<span id="funMovementText">Super Fun Movement</span></td>
		  <td><button type="button" onclick="startTheTour(19)">?</button></td>
                </tr>
                <tr>
		  <td class="small"><div class="random"><button id="funSuitsRandom" type="button" onclick="randomize(event, 'funSuits')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td colspan="2" class="full" id="funSuitsStep">{{displayCheckbox("funSuits")}}<span id="funSuitsText">Suitless</span></td>
		  <td><button type="button" onclick="startTheTour(20)">?</button></td>
                </tr>
              </table>
	    </div>
	    <div id="patchesVisibility">
	      <h4 id="patchesStep">Patches<span class="right"><button type="button" onclick="startTheTour(21)">?</button></span></h4>
	      <p id="mainPatchesTextVisibitily">
	        The bug fix <a href="https://itemrando.supermetroid.run/information">patches</a> from Total Item Randomizer are included by default.
	      </p>
	      <table class="full" id="mainPatchesVisibitily">
	        <tr>
		  <td class="full" id="layoutPatchesStep">{{displayCheckbox("layoutPatches", True)}} Include layout patches from Total Item Randomizer</td>
		  <td><button type="button" onclick="startTheTour(22)">?</button></td>
	        </tr>
	        <tr>
		  <td class="full" id="noGravHeatStep">{{displayCheckbox("noGravHeat", True)}} Remove Gravity Suit heat protection (by Total)</td><td><button type="button" onclick="startTheTour(23)">?</button></td>
	        </tr>
	        <tr>
		  <td class="full" id="variaTweaksStep">{{displayCheckbox("variaTweaks", True)}} VARIA tweaks (by Flo)</td><td><button type="button" onclick="startTheTour(24)">?</button></td>
	        </tr>
	      </table>
	      <table class="full" id="patchesStep">
{{
for patch in patches:
  response.write("	    <tr>", escape=False)
  response.write("	      <td class=\"full\" id=\"{}Visibitily\">".format(patch[0]), escape=False)
  displayCheckbox(patch[0], patches[2])
  response.write("{}".format(patch[1]))
  response.write("	    </tr>", escape=False)
  pass
}}
	      </table>
	    </div>
	  </div>
        </div>
        {{=INPUT(_type="submit", _value="Randomize", _id="submitBtn", _class="btn btn-default buttonRandom")}}
    </form>
  </div>
</body>
