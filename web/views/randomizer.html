{{
extend 'layout.html'
}}


<meta name="description" content="Solver for the randomized Super Metroid roms"/>
<link rel="shortcut icon" href={{=URL('static','favicon.ico')}} type="image/ico"/>
<script src="{{=URL('static','js/FileSaver.js')}}"></script>

<title>Super Metroid Item Randomizer</title>

<style>
.checked {
    color: orange;
}
  a:link {color: SteelBlue;}
  a:visited {color: gray;}
  .web2py-menu-active {border: 2px solid gray;
                       border-radius: 12px;}
label {
    font-weight: normal !important;
}

.check {
    width: 1%;
    white-space: nowrap;
}
.name {
    width: 10%;
    white-space: nowrap;
}
.diff {
    width: 1%;
    white-space: nowrap;
}
.desc {
    width: 33%;
}
.rooms {
    width: 33%;
}
.full {
    width: 100%;
}
.threequarter {
    width: 75%;
}
.half {
    width: 50%;
}
.third {
    width: 33%;
}
.quarter {
    width: 25%;
}
.center {
    text-align: center;
}
.right {
    text-align: right;
}
.nopadding {
    background: linear-gradient(to right, #ddd, #fff);
    padding-left: 10px;
    padding-right: 0px;
    padding-top: 5px;
    padding-bottom: 5px;
    position: relative;
    left: -0.2em;
}
.linethrough {
    text-decoration: line-through;
}

.fixed {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background-color: #ddd;
    width: 100%;
    z-index: 100;
    border-bottom: 2px solid #666;
}
@media (max-width: 1200px) {
    .fixed {
        position: relative;
    }
}
@media (min-width: 1200px) {
    .main {
        margin-top: 2em; /* Add a top margin to avoid content overlay */
    }
}

.main-container {
    margin-top: 0px;
}

body {
    padding-top: 0px;
    margin-bottom: 0px;
}

input, .none {
}

.fill {
    width:100%;
    padding-left:0px;
    padding-right:0px;
}

.menu {
    width: 100%;
    background-color: #333;
    color: #eee;
    text-align: center;
}

a.menu:link {
    color: #eee;
    padding-left: 4em;
    padding-right: 4em;
    font-weight: bold;
}
a.menu:visited {
    color: #eee;
    padding-left: 4em;
    padding-right: 4em;
    font-weight: bold;
}

.filldropdown {
    width:100%;
    padding-left:0px;
    padding-right:0px;
}

table {
    border-collapse: collapse;
}

th {
    padding-left: 5px;
    padding-right: 5px;
    padding-top: 0px;
    padding-bottom: 0px;
}

td {
    padding-left: 5px;
    padding-right: 5px;
    padding-top: 0px;
    padding-bottom: 0px;

    border-bottom: 1px solid #ddd;
}

h3, form {
    margin: 0.1em;
}

.paddingleft {
    padding-left: 10px;
}

p {
    margin: 0.5em;
}

/* https://www.w3schools.com/howto/howto_css_two_columns.asp */
* {
    box-sizing: border-box;
}
.column {
    float: left;
    width: 50%;
    padding-left: 10px;
}
.row:after {
    content: "";
    display: table;
    clear: both;
}
@media (max-width: 800px) {
    .column {
        width: 100%;
    }
}
.container-fluid {
    padding-left: 0px;
    padding-right: 0px;
}
.col-md-12 {
    padding-left: 1em;
    padding-right: 1em;
}
.btn {
    padding: 0.2em 2.5em;
}
#myOverlay {
    position: fixed;
    height: 100%;
    width: 100%;
}
#myOverlay {
    background: fixed;
    opacity: .5;
    z-index: 200;
    display: none;
}
#loadingGIF {
    position: absolute;
    top: 40%;
    left: 45%;
    z-index: 3;
    display:none;
}
.hidden {
    display: none;
}
</style>

<script type="text/javascript">
function AjaxCallCompleted(data) {
    // with items/Locations patch the local rom in memory
    var filesInput = document.getElementById("uploadFile");
    var file = filesInput.files[0]

    var reader = new FileReader();
    reader.readAsArrayBuffer(file)

    reader.onload = function(e) {
        var bytes = new Uint8Array(e.target.result);

        for(var key in data) {
            if(key === "fileName") { continue; }
            console.log(key+": "+data[key]);
            bytes[key] = data[key];
        }

        var blob = new Blob([bytes], {type: "octet/stream"})

        var outFileName = data['fileName']
        saveAs(blob, outFileName)
    }

    // set backup button text to Randomize
    document.getElementById("submitBtn").data = "Randomize";
    console.log("button text set back to randomize");

    // remove "working" message
    $('#myOverlay').hide();
    $('#loadingGIF').hide();
}

function doSubmit() {
  if(window.File && window.FileList && window.FileReader) {

    var filesInput = document.getElementById("uploadFile");
    var file = filesInput.files[0]
    if (file === undefined) {
      alert("Please select an already randomized ROM first")
      btn = document.getElementById("submitBtn");
      btn.data = "Randomize";
      btn.disabled = false;

      setTimeout(function(){ 
          btn = document.getElementById("submitBtn");
          btn.data = "Randomize";
          btn.disabled = false;
      }, 1000);

      return false;
    }

    console.log("uploadFile=["+file+"]")

    // call web service with parameters
    ajax('{{=URL(f='randomizerWebService.json')}}',
         ['seed', 'algo', 'difficulty_target', 'paramsFile'],
         'target',
         {done: AjaxCallCompleted});

    // while WS is working, display "working" message
    $('#myOverlay').show();
    $('#loadingGIF').show();

    setTimeout(function(){ 
        $('#myOverlay').hide();
        $('#loadingGIF').hide();
    }, 10000);
  }

  return false;
}

window.onload = function(){
    //Check File API support
    if(window.File && window.FileList && window.FileReader) {
        var filesInput = document.getElementById("uploadFile");
        filesInput.addEventListener("change", function(event){
            var files = event.target.files; //It returns a FileList object
            var file = files[0];

            var reader = new FileReader();
            reader.onload = function(e) {
		// check sfc or smc extention
                var re = /(?:\.([^.]+))?$/;
		var ext = re.exec(file.name)[1];
                console.log("ext: "+ext)
                if( ! (ext === "sfc" || ext === "smc") ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong extension: "+ext);
                    return false;
                }

                var fileSize = file.size;
		if( fileSize > 4*1024*1024 ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong rom file size: "+fileSize.toString());
                    return false;
                }
            }

            reader.readAsArrayBuffer(file)

        }, false);
    } else {
        alert("This website requires the HTML5 File API, please upgrade your browser to a newer version.");
    }
}
</script>

<body>
  <div id="myOverlay"></div>
  <div id="loadingGIF"><img src={{=URL('static/images','ajax-loader.gif')}}/></div>


  <div class="fixed">
    <div class="menu">
      {{=A('Super Metroid Item Randomizer Solver', _href=URL(f='solver'), _class='menu')}}
      {{=A('Solve!', _href=URL(f='solver'), _class='menu')}}
      {{=A('Randomize!', _href=URL(f='randomizer'), _class='menu')}}
      {{=A('Information & Contact', _href=URL(f='infos'), _class='menu')}}
    </div>
  </div>

  <div class="main">

    <p>
      Vanilla Super Metroid ROM:
    </p>
    <p>
      {{
      =INPUT(_type="file", _name="uploadFile", _id="uploadFile", _form="mainform")
      }}
    </p>

    <p>
      Randomizer seed:
    </p>
    <p>
      {{
      =INPUT(_type="text", _name="seed", _id="seed", _form="mainform", value=0)
      }}
    </p>

    <p>
      The maximum difficulty for picking up an item:
    </p>
    <p>
      {{
      =SELECT('easy', 'medium', 'hard', 'very hard', 'hardcore', 'mania',
              _id="difficulty_target",
              _name="difficulty_target",
              _form="mainform",
              #_class="filldropdown",
              requires=IS_IN_SET(['easy', 'medium', 'hard', 'very hard', 'hardcore', 'mania']),
              value="medium")
      }}
    </p>

    <p>
      The preset used to randomize:
    </p>
    <p>
      {{
      =SELECT(*presets,
              **dict(_id="paramsFile", _name="paramsFile",
                     _form="mainform", #_class="filldropdown",
                     value="medium"))
      }}
    </p>

    {{
    =FORM(INPUT(_type="submit", _value="Randomize", _id="submitBtn"),
                _id="mainform", _name="mainform", _onsubmit="doSubmit(); return false;")
    }}

    <p>
      The patches included by default:
      <ul>
        <li>Intro/Ceres Skip and initial door flag setup</li>
        <li>Instantly open G4 passage when all bosses are killed</li>
        <li>Wake up zebes when going right from morph</li>
        <li>Seed display</li>
        <li>Custom credits with stats</li>
        <li>Removes Gravity Suit heat protection</li>
        <li>Mother Brain Cutscene Edits</li>
        <li>Suit acquisition animation skip</li>
        <li>Fix Morph & Missiles Room State</li>
        <li>Fix heat damage speed echoes bug</li>
        <li>Disable GT Code</li>
        <li>Disable Space/Time select in menu</li>
        <li>Fix Morph Ball Hidden/Chozo PLM's</li>
        <li>Fix Screw Attack selection in menu</li>
      </ul>
    </p>
    <p>
      The layout patches included by default:
      <ul>
        <li>Disable respawning blocks at dachora pit</li>
        <li>Make it possible to escape from below early super bridge without bombs</li>
        <li>Replace bomb blocks with shot blocks before Hi-Jump</li>
        <li>Replace bomb blocks with shot blocks at Moat</li>
        <li>Raise platform in first heated norfair room to not require hi-jump</li>
        <li>Raise platforms in red tower bottom to always be able to get back up</li>
        <li>Replace bomb blocks with shot blocks before Spazer</li>
      </ul>
    </p>

    <p>
      Optional patches to add to the randomized ROM:
      <ul>
        <li>Allows the aim buttons to be assigned to any button</li>
        <li>Remove fanfare when picking up an item</li>
        <li>Allows Samus to start spinning in mid air after jumping or falling</li>
        <li>Play music with MSU1 chip on SD2SNES</li>
        <li>Max Ammo Display</li>
    </ul>
    </p>

  </div>
</body>
