{{
extend 'layout.html'
}}


<meta name="description" content="Solver for the randomized Super Metroid roms"/>
<link rel="shortcut icon" href={{=URL('static','favicon.ico')}} type="image/ico"/>
<link rel="stylesheet" type="text/css" href={{=URL('static/css','mystyle.css')}} media="screen"/>
<script type="text/javascript" src="{{=URL('static', '/highslide/highslide.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "/highslide/highslide.css")}} />
<script type="text/javascript">
hs.graphicsDir = "/solver/static/highslide/graphics/";
hs.showCredits = 0;
hs.zIndexCounter = 1000000;
hs.dimmingOpacity = 0.75;

if (hs.registerOverlay) {
	// The simple semitransparent close button overlay
	hs.registerOverlay({
		thumbnailId: 'areathumb',
		html: '<div class="closebutton"	onclick="return hs.close(this)" title="Close"></div>',
		position: 'top right',
		fade: 2 // fading the semi-transparent overlay looks bad in IE
	});
}
</script>

<title>Super Metroid VARIA Solver</title>

<style>
.main {
    margin-bottom: 1em;
}
</style>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
function guessRomType(filename) {
  var re = /VARIA_Randomizer_[A]?[F]?X\d+/;
  var match = filename.match(re);

  if (match != null) {
    switch(match[0][17]) {
      case 'A':
        switch(match[0][18]) {
          case 'F':
            return "VARIA Area Full";
          case 'X':
            return "VARIA Area Classic";
        }
      case 'F':
        return "VARIA Full";
      case 'X':
        return "VARIA Classic";
    }
  }

  var re = /[CTFH]?X\d+/;
  var match = filename.match(re);

  if (match != null) {
    switch(match[0][0]) {
      case 'C':
        return "Total Casual";
      case 'T':
        return "Total Tournament";
      case 'F':
        return "Total Full";
      case 'H':
        return "Total Hard";
      case 'X':
        return "Total Normal";
    }
  }

  var re = /[CMS]?\d+/;
  var match = filename.match(re);

  if (match != null) {
    switch(match[0][0]) {
      case 'C':
        return "Dessy Casual";
      case 'M':
        return "Dessy Masochist";
      case 'S':
        return "Dessy Speedrunner";
    }
  }

  var re = /Super[ _]*Metroid/;
  var match = filename.match(re);

  if (match != null) {
    return "Vanilla";
  }

  // default to TX
  return "Total Tournament";
}
function showPath()
{
  if(document.getElementById('displayPath').checked) {
    document.getElementById('path_div').style.display = "block";
  } else {
    document.getElementById('path_div').style.display = "none";
  }
}

{{
if resultText is not None:
}}

      google.charts.load('current', {'packages':['timeline']});
      google.charts.setOnLoadCallback(drawChart);


      function drawChart() {
        var container = document.getElementById('timeline');
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();

        dataTable.addColumn({ type: 'string', id: 'Role' });
        dataTable.addColumn({ type: 'string', id: 'Difficulty' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });
        dataTable.addRows([
{{
if diffPercent == 20 or diffPercent == 40 or diffPercent == 60 or diffPercent == 80:
  diffPercent += 1
  pass

if diffPercent <= 20:
  if diffPercent < 10:
    response.write("[ 'Difficulty', 'easy', new Date(1900, 0, 0), new Date(190{}, 0, 0) ]".format(diffPercent), escape=False)
  else:
    response.write("[ 'Difficulty', 'easy', new Date(1900, 0, 0), new Date(19{}, 0, 0) ]".format(diffPercent), escape=False)
    pass
else:
  response.write("[ 'Difficulty', 'easy', new Date(1900, 0, 0), new Date(1920, 0, 0) ],", escape=False)
  pass
if diffPercent > 20 and diffPercent <= 40:
  response.write("[ 'Difficulty', 'medium', new Date(1920, 0, 0), new Date(19{}, 0, 0) ]".format(diffPercent), escape=False)
elif diffPercent > 40:
  response.write("[ 'Difficulty', 'medium', new Date(1920, 0, 0), new Date(1940, 0, 0) ],", escape=False)
  pass
if diffPercent > 40 and diffPercent <= 60:
  response.write("[ 'Difficulty', 'hard', new Date(1940, 0, 0), new Date(19{}, 0, 0) ]".format(diffPercent), escape=False)
elif diffPercent > 60:
  response.write("[ 'Difficulty', 'hard', new Date(1940, 0, 0), new Date(1960, 0, 0) ],", escape=False)
  pass
if diffPercent > 60 and diffPercent <= 80:
  response.write("[ 'Difficulty', 'very hard', new Date(1960, 0, 0), new Date(19{}, 0, 0) ]".format(diffPercent), escape=False)
elif diffPercent > 80:
  response.write("[ 'Difficulty', 'very hard', new Date(1960, 0, 0), new Date(1980, 0, 0) ],", escape=False)
  pass
if diffPercent > 80 and diffPercent <= 100:
  if diffPercent == 100:
    diffPercent = 99
    pass
  response.write("[ 'Difficulty', 'hardcore', new Date(1980, 0, 0), new Date(19{}, 0, 0) ]".format(diffPercent), escape=False)
  pass
}}
          ]);

        var options = {
          hAxis: {
            minValue: new Date(1900, 0, 0),
            maxValue: new Date(2000, 0, 0)
          },
          timeline: { groupByRowLabel: true},
          tooltip: { trigger: 'none' },
          colors: ['#6daa53', '#f1be0b', '#e69235', '#d13434', '#000000'],
          avoidOverlappingGridLines: false,
        };

function allReady() {
    var e = document.getElementById('timeline');
    // svg elements don't have inner/outerHTML properties, so use the parents
    alert(e.getElementsByTagName('svg')[0].parentNode.innerHTML);
}

    google.visualization.events.addListener(chart, 'ready', function () {
      // remove haxis label
      var labels = container.getElementsByTagName('text');

      for (i = 0; i < labels.length; i++) {
        // console.log(labels[i].textContent)
        if (labels[i].textContent.substring(0,2) == '19') {
          //console.log("found")
          labels[i].parentNode.removeChild(labels[i]);
          i--;
        }
      }

    });
//google.visualization.events.addListener(chart, 'ready', allReady);
        chart.draw(dataTable, options);
}
{{
pass
}}

window.onload = function(){
    //Check File API support
    if(window.File && window.FileList && window.FileReader)
    {
        var filesInput = document.getElementById("uploadFile");
        filesInput.addEventListener("change", function(event){
            var files = event.target.files; //It returns a FileList object
            var file = files[0];

            var reader = new FileReader();

            reader.onload = function(e) {
		// check sfc or smc extention
                var re = /(?:\.([^.]+))?$/;
		var ext = re.exec(file.name)[1];
                if( ! (ext === "sfc" || ext === "smc") ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong extension: "+ext);
                    return false;
                }

                var re = /((.*)\.[^.]+)?$/;
                var base = re.exec(file.name)[1];

                var outFileName = file.name.replace(/\.[^/.]+$/, ".json");

                var fileSize = file.size;
		if( fileSize > 4*1024*1024 ) {
                    document.getElementById("uploadFile").value = "";
                    alert("Wrong ROM file size: "+fileSize.toString());
                    return false;
                }

                var bytes = new Uint8Array(e.target.result);

                // locations items
                var addresses = new Array(0x78264, 0x78404, 0x78432, 0x7852C, 0x78614, 0x786DE, 0x7879E, 0x787C2, 0x787FA, 0x78824, 0x78876, 0x7896E, 0x7899C, 0x78ACA, 0x78B24, 0x78BA4, 0x78BAC, 0x78C36, 0x78C3E, 0x78C82, 0x78CCA, 0x79108, 0x79110, 0x79184, 0x7C2E9, 0x7C337, 0x7C365, 0x7C36D, 0x7C47D, 0x7C559, 0x7C5E3, 0x7C6E5, 0x7C755, 0x7C7A7, 0x781CC, 0x781E8, 0x781EE, 0x781F4, 0x78248, 0x783EE, 0x78464, 0x7846A, 0x78478, 0x78486, 0x784AC, 0x784E4, 0x78518, 0x7851E, 0x78532, 0x78538, 0x78608, 0x7860E, 0x7865C, 0x78676, 0x7874C, 0x78798, 0x787D0, 0x78802, 0x78836, 0x7883C, 0x788CA, 0x7890E, 0x78914, 0x789EC, 0x78AE4, 0x78B46, 0x78BC0, 0x78BE6, 0x78BEC, 0x78C04, 0x78C14, 0x78C2A, 0x78C44, 0x78C52, 0x78C66, 0x78C74, 0x78CBC, 0x78E6E, 0x78E74, 0x78F30, 0x78FCA, 0x78FD2, 0x790C0, 0x79100, 0x7C265, 0x7C2EF, 0x7C319, 0x7C357, 0x7C437, 0x7C43D, 0x7C483, 0x7C4AF, 0x7C4B5, 0x7C533, 0x7C5DD, 0x7C5EB, 0x7C5F1, 0x7C603, 0x7C609, 0x7C74D);
                var romData = {};

                var arrayLength = addresses.length;
                for(var i=0; i<arrayLength; i++) {
                    romData[addresses[i]] = bytes[addresses[i]]
                    romData[addresses[i]+1] = bytes[addresses[i]+1]
                    romData[addresses[i]+4] = bytes[addresses[i]+4]
                }

                // check if layout patches are present
                romData[0x21BD80] = bytes[0x21BD80]
                // check if no grav heat patch is present
                romData[0x06e37d] = bytes[0x06e37d]

                // transitions
                var addresses = new Array(0x18c22, 0x18aea, 0x18a42, 0x18e9e, 0x18bfe, 0x18e86, 0x18f0a, 0x189ca, 0x18aae, 0x196d2, 0x19a4a, 0x1922e, 0x195fa, 0x1967e, 0x1a39c, 0x1a510, 0x18aa2, 0x1a480, 0x1902a, 0x190c6, 0x18af6, 0x1a384, 0x1a390, 0x1a330, 0x18c52, 0x191e6);
                var arrayLength = addresses.length;
                for(var i=0; i<arrayLength; i++) {
                    romData[addresses[i]] = bytes[addresses[i]]
                    romData[addresses[i]+1] = bytes[addresses[i]+1]
                    romData[addresses[i]+6] = bytes[addresses[i]+6]
                    romData[addresses[i]+7] = bytes[addresses[i]+7]
                }

                romData["romFileName"] = outFileName;

                var json = JSON.stringify(romData)

                var output = document.getElementById("json");
                output.value = json;

                var romType = guessRomType(file.name);
                document.getElementById("romType").value = romType;

                var option = document.createElement('option');
                option.text = option.value = file.name;
                var select = document.getElementById("romFile");
                select.add(option, 0);
                select.value = option.value;
            }

            reader.readAsArrayBuffer(file)

        }, false);
    }
}

</script>

<body>

<div class="fixed">
  <div class="menu">
    {{=A("Super Metroid VARIA Randomizer and Solver", _href=URL(f="solver"), _class="menu")}}
    {{=A("Presets", _href=URL(f="presets"), _class="menu")}}
    {{=A("Solver", _href=URL(f="solver"), _class="menu")}}
    {{=A("Randomizer", _href=URL(f="randomizer"), _class="menu")}}
    {{=A("Information & Contact", _href=URL(f="infos"), _class="menu")}}
  </div>
</div>

<p>
  Choose your randomized ROM to solve, the preset to use then press 'Compute Difficulty'.
  {{=mainForm}}
</p>

<div class="main">

{{
if resultText is not None:
  =resultText

  difficulties = {
      easy : 'easy',
      medium : 'medium',
      hard : 'hard',
      harder : 'very hard',
      hardcore : 'hardcore',
      mania : 'mania',
      mania*2: 'god'
  }

  response.write("</table>", escape=False)

  response.write("<br/>", escape=False)
  pass
}}

{{
if resultText is not None and difficulty != -1:
}}
<div id="timeline" style="height: 95px; width: 50%;"></div>

<p>
  To solve this ROM {{=knowsUsed[0]}} distinct techniques have been used out of the {{=knowsUsed[1]}} known techniques.
</p>
{{
  if itemsOk is False:
}}
<p>
  Warning: the ROM is finishable, but we couldn't pickup all the requested items.
</p>

{{
    pass
  pass
}}


{{
if resultText is not None:
  response.write("<input id=\"displayPath\" name=\"displayPath\" type=\"checkbox\" onClick=\"showPath()\">\n", escape=False)
  response.write("Display the generated path (spoilers)")

  response.write("<div id=\"path_div\" style=\"display:none;\">\n", escape=False)
  response.write("<hr>\n", escape=False)
  =pathTable

  if pngFileName is not None and pngThumbFileName is not None:
    response.write("<p>The graph of the Areas transitions</p>", escape=False)
    response.write("<a href=\"/solver/static/graph/"+pngFileName+"\" class=\"highslide\" onclick=\"return hs.expand(this, {wrapperClassName: 'borderless', dimmingOpacity: 0.75, align: 'center'})\"><img id=\"transitionsthumb\" src=\"/solver/static/graph/"+pngThumbFileName+"\" alt=\"Transitions Graph\" title=\"Click to enlarge\"/></a>", escape=False)
    pass

  response.write("</div>\n", escape=False)
  pass
}}

</div>
</body>
